{"version":3,"sources":["../src/SpeculosTransport.js"],"names":["SpeculosTransport","Transport","constructor","apduSocket","opts","rejectExchange","_e","resolveExchange","_b","automationSocket","automationEvents","Subject","button","command","Promise","resolve","reject","buttonPort","host","Error","socket","net","Socket","on","e","destroy","connect","write","Buffer","from","emit","DisconnectedDevice","message","DisconnectedDeviceDuringOperation","data","decodeAPDUPayload","automationPort","String","split","toString","filter","ascii","forEach","json","JSON","parse","next","exchange","apdu","hex","encoded","encodeAPDU","res","setScrambleKey","close","isSupported","list","listen","_observer","unsubscribe","open","apduPort","setTimeout","size","allocUnsafe","writeUIntBE","length","concat","dataLength","readUIntBE","payload","slice","TransportError"],"mappings":"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","sourcesContent":["//@flow\nimport { Subject } from \"rxjs\";\nimport net from \"net\";\nimport Transport from \"@ledgerhq/hw-transport\";\nimport {\n  DisconnectedDevice,\n  DisconnectedDeviceDuringOperation,\n  TransportError,\n} from \"@ledgerhq/errors\";\nimport { log } from \"@ledgerhq/logs\";\n\n/**\n *\n */\nexport type SpeculosTransportOpts = {\n  apduPort: number,\n  buttonPort?: number,\n  automationPort?: number,\n  host?: string,\n};\n\n/**\n * Speculos TCP transport implementation\n *\n * @example\n * import SpeculosTransport from \"@ledgerhq/hw-transport-node-speculos\";\n * const transport = await SpeculosTransport.open({ apduPort });\n * const res = await transport.send(0xE0, 0x01, 0, 0);\n */\nexport default class SpeculosTransport extends Transport<SpeculosTransportOpts> {\n  static isSupported = (): Promise<boolean> => Promise.resolve(true);\n\n  // this transport is not discoverable\n  static list = (): * => Promise.resolve([]);\n  static listen = (_observer: *) => ({\n    unsubscribe: () => {},\n  });\n\n  /**\n   *\n   */\n  static open = (opts: SpeculosTransportOpts): Promise<SpeculosTransport> =>\n    new Promise((resolve, reject) => {\n      const socket = new net.Socket();\n      socket.on(\"error\", (e) => {\n        socket.destroy();\n        reject(e);\n      });\n      socket.on(\"end\", () => {\n        reject(new DisconnectedDevice(\"tcp closed\"));\n      });\n      socket.connect(opts.apduPort, opts.host || \"127.0.0.1\", () => {\n        // we delay a bit the transport creation to make sure the tcp does not hang up\n        setTimeout(() => {\n          resolve(new SpeculosTransport(socket, opts));\n        }, 100);\n      });\n    });\n\n  apduSocket: net.Socket;\n  opts: SpeculosTransportOpts;\n  rejectExchange: (Error) => void = (_e) => {};\n  resolveExchange: (Buffer) => void = (_b) => {};\n\n  automationSocket: ?net.Socket;\n  automationEvents: Subject<Object> = new Subject();\n\n  constructor(apduSocket: net.Socket, opts: SpeculosTransportOpts) {\n    super();\n    this.opts = opts;\n    this.apduSocket = apduSocket;\n    apduSocket.on(\"error\", (e) => {\n      this.emit(\"disconnect\", new DisconnectedDevice(e.message));\n      this.rejectExchange(e);\n      this.apduSocket.destroy();\n    });\n    apduSocket.on(\"end\", () => {\n      this.emit(\"disconnect\", new DisconnectedDevice());\n      this.rejectExchange(new DisconnectedDeviceDuringOperation());\n    });\n    apduSocket.on(\"data\", (data) => {\n      try {\n        this.resolveExchange(decodeAPDUPayload(data));\n      } catch (e) {\n        this.rejectExchange(e);\n      }\n    });\n\n    const { automationPort } = opts;\n    if (automationPort) {\n      const socket = new net.Socket();\n      this.automationSocket = socket;\n      socket.on(\"error\", (e) => {\n        log(\"speculos-automation-error\", String(e));\n        socket.destroy();\n      });\n      socket.on(\"data\", (data) => {\n        log(\"speculos-automation-data\", data);\n        const split = data.toString(\"ascii\").split(\"\\n\");\n        split\n          .filter((ascii) => !!ascii)\n          .forEach((ascii) => {\n            const json = JSON.parse(ascii);\n            this.automationEvents.next(json);\n          });\n      });\n      socket.connect(automationPort, opts.host || \"127.0.0.1\");\n    }\n  }\n\n  /**\n   * Send a speculos button command\n   * typically \"Ll\" would press and release the left button\n   * typically \"Rr\" would press and release the right button\n   * @param {*} command\n   */\n  button = (command: string): Promise<void> =>\n    new Promise((resolve, reject) => {\n      log(\"speculos-button\", command);\n      const { buttonPort, host } = this.opts;\n      if (!buttonPort) throw new Error(\"buttonPort is missing\");\n      const socket = new net.Socket();\n      socket.on(\"error\", (e) => {\n        socket.destroy();\n        reject(e);\n      });\n      socket.connect(buttonPort, host || \"127.0.0.1\", () => {\n        socket.write(Buffer.from(command, \"ascii\"));\n        socket.destroy();\n        resolve();\n      });\n    });\n\n  async exchange(apdu: Buffer): Promise<Buffer> {\n    const hex = apdu.toString(\"hex\");\n    log(\"apdu\", \"=> \" + hex);\n    const encoded = encodeAPDU(apdu);\n    const res = await new Promise((resolve, reject) => {\n      this.rejectExchange = reject;\n      this.resolveExchange = resolve;\n      this.apduSocket.write(encoded);\n    });\n    log(\"apdu\", \"<= \" + res.toString(\"hex\"));\n    return res;\n  }\n\n  setScrambleKey() {}\n\n  async close() {\n    if (this.automationSocket) this.automationSocket.destroy();\n    this.apduSocket.destroy();\n    return Promise.resolve();\n  }\n}\n\nfunction encodeAPDU(apdu: Buffer) {\n  const size = Buffer.allocUnsafe(4);\n  size.writeUIntBE(apdu.length, 0, 4);\n  return Buffer.concat([size, apdu]);\n}\n\nfunction decodeAPDUPayload(data: Buffer) {\n  const dataLength = data.readUIntBE(0, 4); // 4 bytes tells the data length\n  const size = dataLength + 2; // size does not include the status code so we add 2\n  const payload = data.slice(4);\n  if (payload.length !== size) {\n    throw new TransportError(\n      `Expected payload of length ${size} but got ${payload.length}`\n    );\n  }\n  return payload;\n}\n"],"file":"SpeculosTransport.js"}
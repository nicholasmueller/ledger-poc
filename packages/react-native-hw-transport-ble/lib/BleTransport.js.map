{"version":3,"sources":["../src/BleTransport.js"],"names":["connectOptions","requestMTU","transportsCache","bleManager","BleManager","retrieveInfos","device","serviceUUIDs","serviceUUID","infos","reconnectionConfig","pairingThreshold","delayAfterFirstPairing","setReconnectionConfig","config","delay","ms","Promise","success","setTimeout","open","deviceOrId","needsReconnect","devices","length","connectedDevices","connectedDevicesFiltered","filter","d","id","connectToDevice","e","errorCode","BleErrorCode","DeviceMTUChangeFailed","CantOpenDevice","isConnected","connect","discoverAllServicesAndCharacteristics","res","characteristics","uuid","characteristicsForService","TransportError","deviceModel","serviceUuid","writeUuid","notifyUuid","writeC","notifyC","c","isWritableWithResponse","isNotifiable","mtu","notifyObservable","pipe","value","toString","notif","subscribe","transport","BluetoothTransport","onDisconnect","notYetDisconnected","unsubscribe","disconnectedSub","remove","emit","onDisconnected","beforeMTUTime","Date","now","inferMTU","afterMTUTime","disconnect","catch","Transport","observeState","observer","emitFromState","type","next","available","onStateChange","listen","unsubscribed","stateSub","state","all","map","startDeviceScan","bleError","error","descriptor","stopDeviceScan","constructor","writeCharacteristic","mtuSize","exchange","apdu","exchangeAtomicImpl","msgIn","data","receiveAPDU","write","toPromise","msgOut","String","cancelDeviceConnection","buffer","txid","writeWithResponse","DisconnectedDeviceDuringOperation","message","readUInt8","Buffer","from","requestConnectionPriority","connectionPriority","ConnectionPriority","setScrambleKey","close","exchangeBusyPromise","isSupported","resolve","setLogLevel","level","list","Error"],"mappings":"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","sourcesContent":["// @flow\n/* eslint-disable prefer-template */\n\nimport Transport from \"@ledgerhq/hw-transport\";\nimport {\n  BleManager,\n  ConnectionPriority,\n  BleErrorCode,\n} from \"react-native-ble-plx\";\nimport {\n  getBluetoothServiceUuids,\n  getInfosForServiceUuid,\n} from \"@ledgerhq/devices\";\nimport type { DeviceModel } from \"@ledgerhq/devices\";\n\nimport { sendAPDU } from \"@ledgerhq/devices/lib/ble/sendAPDU\";\nimport { receiveAPDU } from \"@ledgerhq/devices/lib/ble/receiveAPDU\";\nimport { log } from \"@ledgerhq/logs\";\nimport { Observable, defer, merge, from } from \"rxjs\";\nimport { share, ignoreElements, first, map, tap } from \"rxjs/operators\";\nimport {\n  CantOpenDevice,\n  TransportError,\n  DisconnectedDeviceDuringOperation,\n} from \"@ledgerhq/errors\";\nimport type { Device, Characteristic } from \"./types\";\nimport { monitorCharacteristic } from \"./monitorCharacteristic\";\nimport { awaitsBleOn } from \"./awaitsBleOn\";\nimport { decoratePromiseErrors, remapError } from \"./remapErrors\";\n\nlet connectOptions = {\n  requestMTU: 156,\n};\n\nconst transportsCache = {};\nconst bleManager = new BleManager();\n\nconst retrieveInfos = (device) => {\n  if (!device || !device.serviceUUIDs) return;\n  const [serviceUUID] = device.serviceUUIDs;\n  if (!serviceUUID) return;\n  const infos = getInfosForServiceUuid(serviceUUID);\n  if (!infos) return;\n  return infos;\n};\n\ntype ReconnectionConfig = {\n  pairingThreshold: number,\n  delayAfterFirstPairing: number,\n};\nlet reconnectionConfig: ?ReconnectionConfig = {\n  pairingThreshold: 1000,\n  delayAfterFirstPairing: 4000,\n};\nexport function setReconnectionConfig(config: ?ReconnectionConfig) {\n  reconnectionConfig = config;\n}\n\nconst delay = (ms) => new Promise((success) => setTimeout(success, ms));\n\nasync function open(deviceOrId: Device | string, needsReconnect: boolean) {\n  let device;\n  if (typeof deviceOrId === \"string\") {\n    if (transportsCache[deviceOrId]) {\n      log(\"ble-verbose\", \"Transport in cache, using that.\");\n      return transportsCache[deviceOrId];\n    }\n\n    log(\"ble-verbose\", `open(${deviceOrId})`);\n\n    await awaitsBleOn(bleManager);\n\n    if (!device) {\n      // works for iOS but not Android\n      const devices = await bleManager.devices([deviceOrId]);\n      log(\"ble-verbose\", `found ${devices.length} devices`);\n      [device] = devices;\n    }\n\n    if (!device) {\n      const connectedDevices = await bleManager.connectedDevices(\n        getBluetoothServiceUuids()\n      );\n      const connectedDevicesFiltered = connectedDevices.filter(\n        (d) => d.id === deviceOrId\n      );\n      log(\n        \"ble-verbose\",\n        `found ${connectedDevicesFiltered.length} connected devices`\n      );\n      [device] = connectedDevicesFiltered;\n    }\n\n    if (!device) {\n      log(\"ble-verbose\", `connectToDevice(${deviceOrId})`);\n      try {\n        device = await bleManager.connectToDevice(deviceOrId, connectOptions);\n      } catch (e) {\n        if (e.errorCode === BleErrorCode.DeviceMTUChangeFailed) {\n          // eslint-disable-next-line require-atomic-updates\n          connectOptions = {};\n          device = await bleManager.connectToDevice(deviceOrId);\n        } else {\n          throw e;\n        }\n      }\n    }\n\n    if (!device) {\n      throw new CantOpenDevice();\n    }\n  } else {\n    device = deviceOrId;\n  }\n\n  if (!(await device.isConnected())) {\n    log(\"ble-verbose\", \"not connected. connecting...\");\n    try {\n      await device.connect(connectOptions);\n    } catch (e) {\n      if (e.errorCode === BleErrorCode.DeviceMTUChangeFailed) {\n        // eslint-disable-next-line require-atomic-updates\n        connectOptions = {};\n        await device.connect();\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  await device.discoverAllServicesAndCharacteristics();\n\n  let res = retrieveInfos(device);\n  let characteristics;\n  if (!res) {\n    for (const uuid of getBluetoothServiceUuids()) {\n      try {\n        characteristics = await device.characteristicsForService(uuid);\n        res = getInfosForServiceUuid(uuid);\n        break;\n      } catch (e) {\n        // we attempt to connect to service\n      }\n    }\n  }\n  if (!res) {\n    throw new TransportError(\"service not found\", \"BLEServiceNotFound\");\n  }\n\n  const { deviceModel, serviceUuid, writeUuid, notifyUuid } = res;\n\n  if (!characteristics) {\n    characteristics = await device.characteristicsForService(serviceUuid);\n  }\n\n  if (!characteristics) {\n    throw new TransportError(\"service not found\", \"BLEServiceNotFound\");\n  }\n  let writeC;\n  let notifyC;\n  for (const c of characteristics) {\n    if (c.uuid === writeUuid) {\n      writeC = c;\n    } else if (c.uuid === notifyUuid) {\n      notifyC = c;\n    }\n  }\n  if (!writeC) {\n    throw new TransportError(\n      \"write characteristic not found\",\n      \"BLEChracteristicNotFound\"\n    );\n  }\n  if (!notifyC) {\n    throw new TransportError(\n      \"notify characteristic not found\",\n      \"BLEChracteristicNotFound\"\n    );\n  }\n  if (!writeC.isWritableWithResponse) {\n    throw new TransportError(\n      \"write characteristic not writableWithResponse\",\n      \"BLEChracteristicInvalid\"\n    );\n  }\n  if (!notifyC.isNotifiable) {\n    throw new TransportError(\n      \"notify characteristic not notifiable\",\n      \"BLEChracteristicInvalid\"\n    );\n  }\n\n  log(\"ble-verbose\", `device.mtu=${device.mtu}`);\n\n  const notifyObservable = monitorCharacteristic(notifyC).pipe(\n    tap((value) => {\n      log(\"ble-frame\", \"<= \" + value.toString(\"hex\"));\n    }),\n    share()\n  );\n\n  const notif = notifyObservable.subscribe();\n\n  const transport = new BluetoothTransport(\n    device,\n    writeC,\n    notifyObservable,\n    deviceModel\n  );\n\n  const onDisconnect = (e) => {\n    transport.notYetDisconnected = false;\n    notif.unsubscribe();\n    disconnectedSub.remove();\n    delete transportsCache[transport.id];\n    log(\"ble-verbose\", `BleTransport(${transport.id}) disconnected`);\n    transport.emit(\"disconnect\", e);\n  };\n\n  // eslint-disable-next-line require-atomic-updates\n  transportsCache[transport.id] = transport;\n  const disconnectedSub = device.onDisconnected((e) => {\n    if (!transport.notYetDisconnected) return;\n    onDisconnect(e);\n  });\n\n  let beforeMTUTime = Date.now();\n  try {\n    await transport.inferMTU();\n  } finally {\n    let afterMTUTime = Date.now();\n\n    if (reconnectionConfig) {\n      // workaround for #279: we need to open() again if we come the first time here,\n      // to make sure we do a disconnect() after the first pairing time\n      // because of a firmware bug\n\n      if (afterMTUTime - beforeMTUTime < reconnectionConfig.pairingThreshold) {\n        needsReconnect = false; // (optim) there is likely no new pairing done because mtu answer was fast.\n      }\n\n      if (needsReconnect) {\n        // necessary time for the bonding workaround\n        await BluetoothTransport.disconnect(transport.id).catch(() => {});\n        await delay(reconnectionConfig.delayAfterFirstPairing);\n      }\n    } else {\n      needsReconnect = false;\n    }\n  }\n\n  if (needsReconnect) {\n    return open(device, false);\n  }\n\n  return transport;\n}\n\n/**\n * react-native bluetooth BLE implementation\n * @example\n * import BluetoothTransport from \"@ledgerhq/react-native-hw-transport-ble\";\n */\nexport default class BluetoothTransport extends Transport<Device | string> {\n  /**\n   *\n   */\n  static isSupported = (): Promise<boolean> =>\n    Promise.resolve(typeof BleManager === \"function\");\n\n  /**\n   *\n   */\n  static setLogLevel = (level: *) => {\n    bleManager.setLogLevel(level);\n  };\n\n  /**\n   * TODO could add this concept in all transports\n   * observe event with { available: bool, string } // available is generic, type is specific\n   * an event is emit once and then listened\n   */\n  static observeState(observer: *) {\n    const emitFromState = (type) => {\n      observer.next({ type, available: type === \"PoweredOn\" });\n    };\n    bleManager.onStateChange(emitFromState, true);\n    return {\n      unsubscribe: () => {},\n    };\n  }\n\n  static list = (): * => {\n    throw new Error(\"not implemented\");\n  };\n\n  /**\n   * Scan for bluetooth Ledger devices\n   */\n  static listen(observer: *) {\n    log(\"ble-verbose\", \"listen...\");\n    let unsubscribed;\n\n    // $FlowFixMe\n    const stateSub = bleManager.onStateChange(async (state) => {\n      if (state === \"PoweredOn\") {\n        stateSub.remove();\n\n        const devices = await bleManager.connectedDevices(\n          getBluetoothServiceUuids()\n        );\n        if (unsubscribed) return;\n\n        await Promise.all(\n          devices.map((d) =>\n            BluetoothTransport.disconnect(d.id).catch(() => {})\n          )\n        );\n        if (unsubscribed) return;\n\n        bleManager.startDeviceScan(\n          getBluetoothServiceUuids(),\n          null,\n          (bleError, device) => {\n            if (bleError) {\n              observer.error(bleError);\n              unsubscribe();\n              return;\n            }\n            const res = retrieveInfos(device);\n            const deviceModel = res && res.deviceModel;\n            observer.next({ type: \"add\", descriptor: device, deviceModel });\n          }\n        );\n      }\n    }, true);\n    const unsubscribe = () => {\n      unsubscribed = true;\n      bleManager.stopDeviceScan();\n      stateSub.remove();\n      log(\"ble-verbose\", \"done listening.\");\n    };\n    return { unsubscribe };\n  }\n\n  /**\n   * Open a BLE transport\n   * @param {*} deviceOrId\n   */\n  static async open(deviceOrId: Device | string) {\n    return open(deviceOrId, true);\n  }\n\n  /**\n   * Globally disconnect a BLE device by its ID\n   */\n  static disconnect = async (id: *) => {\n    log(\"ble-verbose\", `user disconnect(${id})`);\n    await bleManager.cancelDeviceConnection(id);\n  };\n\n  id: string;\n\n  device: Device;\n\n  mtuSize: number = 20;\n\n  writeCharacteristic: Characteristic;\n\n  notifyObservable: Observable<Buffer>;\n\n  deviceModel: DeviceModel;\n\n  notYetDisconnected = true;\n\n  constructor(\n    device: Device,\n    writeCharacteristic: Characteristic,\n    notifyObservable: Observable<Buffer>,\n    deviceModel: DeviceModel\n  ) {\n    super();\n    this.id = device.id;\n    this.device = device;\n    this.writeCharacteristic = writeCharacteristic;\n    this.notifyObservable = notifyObservable;\n    this.deviceModel = deviceModel;\n    log(\"ble-verbose\", `BleTransport(${String(this.id)}) new instance`);\n  }\n\n  /**\n   * communicate with a BLE transport\n   */\n  exchange = (apdu: Buffer): Promise<Buffer> =>\n    this.exchangeAtomicImpl(async () => {\n      try {\n        const msgIn = apdu.toString(\"hex\");\n        log(\"apdu\", `=> ${msgIn}`);\n\n        const data = await merge(\n          // $FlowFixMe\n          this.notifyObservable.pipe(receiveAPDU),\n          sendAPDU(this.write, apdu, this.mtuSize)\n        ).toPromise();\n\n        const msgOut = data.toString(\"hex\");\n        log(\"apdu\", `<= ${msgOut}`);\n\n        return data;\n      } catch (e) {\n        log(\"ble-error\", \"exchange got \" + String(e));\n        if (this.notYetDisconnected) {\n          // in such case we will always disconnect because something is bad.\n          await bleManager.cancelDeviceConnection(this.id).catch(() => {}); // but we ignore if disconnect worked.\n        }\n        throw remapError(e);\n      }\n    });\n\n  // TODO we probably will do this at end of open\n  async inferMTU() {\n    let { mtu } = this.device;\n    await this.exchangeAtomicImpl(async () => {\n      try {\n        mtu =\n          (await merge(\n            this.notifyObservable.pipe(\n              first((buffer) => buffer.readUInt8(0) === 0x08),\n              map((buffer) => buffer.readUInt8(5))\n            ),\n            defer(() => from(this.write(Buffer.from([0x08, 0, 0, 0, 0])))).pipe(\n              ignoreElements()\n            )\n          ).toPromise()) + 3;\n      } catch (e) {\n        log(\"ble-error\", \"inferMTU got \" + String(e));\n        await bleManager.cancelDeviceConnection(this.id).catch(() => {}); // but we ignore if disconnect worked.\n        throw remapError(e);\n      }\n    });\n\n    if (mtu > 23) {\n      const mtuSize = mtu - 3;\n      log(\n        \"ble-verbose\",\n        `BleTransport(${String(this.id)}) mtu set to ${String(mtuSize)}`\n      );\n      this.mtuSize = mtuSize;\n    }\n\n    return this.mtuSize;\n  }\n\n  async requestConnectionPriority(\n    connectionPriority: \"Balanced\" | \"High\" | \"LowPower\"\n  ) {\n    await decoratePromiseErrors(\n      this.device.requestConnectionPriority(\n        ConnectionPriority[connectionPriority]\n      )\n    );\n  }\n\n  setScrambleKey() {}\n\n  write = async (buffer: Buffer, txid?: ?string) => {\n    log(\"ble-frame\", \"=> \" + buffer.toString(\"hex\"));\n    try {\n      await this.writeCharacteristic.writeWithResponse(\n        buffer.toString(\"base64\"),\n        txid\n      );\n    } catch (e) {\n      throw new DisconnectedDeviceDuringOperation(e.message);\n    }\n  };\n\n  async close() {\n    if (this.exchangeBusyPromise) {\n      await this.exchangeBusyPromise;\n    }\n  }\n}\n"],"file":"BleTransport.js"}
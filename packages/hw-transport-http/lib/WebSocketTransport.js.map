{"version":3,"sources":["../src/WebSocketTransport.js"],"names":["WebSocket","global","require","WebSocketTransport","Transport","open","url","exchangeMethods","Promise","resolve","reject","socket","resolveExchange","_b","rejectExchange","_e","onDisconnect","close","send","msg","onopen","onerror","e","onclose","TransportError","onmessage","data","JSON","parse","type","Error","error","Buffer","from","constructor","hook","emit","exchange","apdu","hex","toString","res","b","setScrambleKey","success","setTimeout","isSupported","list","listen","_observer","unsubscribe","check","timeout"],"mappings":"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","sourcesContent":["//@flow\nimport Transport from \"@ledgerhq/hw-transport\";\nimport { TransportError } from \"@ledgerhq/errors\";\nimport { log } from \"@ledgerhq/logs\";\n\nconst WebSocket = global.WebSocket || require(\"ws\");\n\n/**\n * WebSocket transport implementation\n */\nexport default class WebSocketTransport extends Transport<string> {\n  static isSupported = (): Promise<boolean> =>\n    Promise.resolve(typeof WebSocket === \"function\");\n\n  // this transport is not discoverable\n  static list = (): * => Promise.resolve([]);\n  static listen = (_observer: *) => ({\n    unsubscribe: () => {},\n  });\n\n  static check = async (url: string, timeout: number = 5000) =>\n    new Promise((resolve, reject) => {\n      const socket = new WebSocket(url);\n      let success = false;\n      setTimeout(() => {\n        socket.close();\n      }, timeout);\n      socket.onopen = () => {\n        success = true;\n        socket.close();\n      };\n      socket.onclose = () => {\n        if (success) resolve();\n        else {\n          reject(\n            new TransportError(\n              \"failed to access WebSocketTransport(\" + url + \")\",\n              \"WebSocketTransportNotAccessible\"\n            )\n          );\n        }\n      };\n      socket.onerror = () => {\n        reject(\n          new TransportError(\n            \"failed to access WebSocketTransport(\" + url + \"): error\",\n            \"WebSocketTransportNotAccessible\"\n          )\n        );\n      };\n    });\n\n  static async open(url: string) {\n    const exchangeMethods = await new Promise((resolve, reject) => {\n      try {\n        const socket = new WebSocket(url);\n        const exchangeMethods = {\n          resolveExchange: (_b: Buffer) => {},\n          rejectExchange: (_e: *) => {},\n          onDisconnect: () => {},\n          close: () => socket.close(),\n          send: (msg) => socket.send(msg),\n        };\n        socket.onopen = () => {\n          socket.send(\"open\");\n        };\n        socket.onerror = (e) => {\n          exchangeMethods.onDisconnect();\n          reject(e);\n        };\n        socket.onclose = () => {\n          exchangeMethods.onDisconnect();\n          reject(new TransportError(\"OpenFailed\", \"OpenFailed\"));\n        };\n        socket.onmessage = (e) => {\n          if (typeof e.data !== \"string\") return;\n          const data = JSON.parse(e.data);\n          switch (data.type) {\n            case \"opened\":\n              return resolve(exchangeMethods);\n            case \"error\":\n              reject(new Error(data.error));\n              return exchangeMethods.rejectExchange(\n                new TransportError(data.error, \"WSError\")\n              );\n            case \"response\":\n              return exchangeMethods.resolveExchange(\n                Buffer.from(data.data, \"hex\")\n              );\n          }\n        };\n      } catch (e) {\n        reject(e);\n      }\n    });\n    return new WebSocketTransport(exchangeMethods);\n  }\n\n  hook: *;\n\n  constructor(hook: *) {\n    super();\n    this.hook = hook;\n    hook.onDisconnect = () => {\n      this.emit(\"disconnect\");\n      this.hook.rejectExchange(\n        new TransportError(\"WebSocket disconnected\", \"WSDisconnect\")\n      );\n    };\n  }\n\n  async exchange(apdu: Buffer): Promise<Buffer> {\n    const hex = apdu.toString(\"hex\");\n    log(\"apdu\", \"=> \" + hex);\n    const res = await new Promise((resolve, reject) => {\n      this.hook.rejectExchange = (e: *) => reject(e);\n      this.hook.resolveExchange = (b: Buffer) => resolve(b);\n      this.hook.send(hex);\n    });\n    log(\"apdu\", \"<= \" + res.toString(\"hex\"));\n    return res;\n  }\n\n  setScrambleKey() {}\n\n  async close() {\n    this.hook.close();\n    return new Promise((success) => {\n      setTimeout(success, 200);\n    });\n  }\n}\n"],"file":"WebSocketTransport.js"}
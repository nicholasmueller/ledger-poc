{"version":3,"sources":["../src/HttpTransport.js"],"names":["HttpTransport","Transport","open","url","timeout","check","constructor","exchange","apdu","apduHex","toString","response","method","headers","Accept","data","JSON","stringify","status","TransportError","body","error","Buffer","from","setScrambleKey","close","Promise","resolve","isSupported","fetch","list","listen","_observer","unsubscribe"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;;;AAEA;;;AAGe,MAAMA,aAAN,SAA4BC,oBAA5B,CAA8C;AAI3D;AAmBA,eAAaC,IAAb,CAAkBC,GAAlB,EAA+BC,OAA/B,EAAiD;AAC/C,UAAMJ,aAAa,CAACK,KAAd,CAAoBF,GAApB,EAAyBC,OAAzB,CAAN;AACA,WAAO,IAAIJ,aAAJ,CAAkBG,GAAlB,CAAP;AACD;;AAIDG,EAAAA,WAAW,CAACH,GAAD,EAAc;AACvB;AADuB,SAFzBA,GAEyB;AAEvB,SAAKA,GAAL,GAAWA,GAAX;AACD;;AAED,QAAMI,QAAN,CAAeC,IAAf,EAA8C;AAC5C,UAAMC,OAAO,GAAGD,IAAI,CAACE,QAAL,CAAc,KAAd,CAAhB;AACA,mBAAI,MAAJ,EAAY,QAAQD,OAApB;AACA,UAAME,QAAQ,GAAG,MAAM,oBAAM;AAC3BC,MAAAA,MAAM,EAAE,MADmB;AAE3BT,MAAAA,GAAG,EAAE,KAAKA,GAFiB;AAG3BU,MAAAA,OAAO,EAAE;AACPC,QAAAA,MAAM,EAAE,kBADD;AAEP,wBAAgB;AAFT,OAHkB;AAO3BC,MAAAA,IAAI,EAAEC,IAAI,CAACC,SAAL,CAAe;AAAER,QAAAA;AAAF,OAAf;AAPqB,KAAN,CAAvB;;AASA,QAAIE,QAAQ,CAACO,MAAT,KAAoB,GAAxB,EAA6B;AAC3B,YAAM,IAAIC,sBAAJ,CACJ,2CAA2CR,QAAQ,CAACO,MADhD,EAEJ,wBAAwBP,QAAQ,CAACO,MAF7B,CAAN;AAID;;AACD,UAAME,IAAI,GAAG,MAAMT,QAAQ,CAACI,IAA5B;AACA,QAAIK,IAAI,CAACC,KAAT,EAAgB,MAAMD,IAAI,CAACC,KAAX;AAChB,mBAAI,MAAJ,EAAY,QAAQD,IAAI,CAACL,IAAzB;AACA,WAAOO,MAAM,CAACC,IAAP,CAAYH,IAAI,CAACL,IAAjB,EAAuB,KAAvB,CAAP;AACD;;AAEDS,EAAAA,cAAc,GAAG,CAAE;;AAEnBC,EAAAA,KAAK,GAAkB;AACrB,WAAOC,OAAO,CAACC,OAAR,EAAP;AACD;;AA/D0D;;;;AAAxC3B,a,CACZ4B,W,GAAc,MACnBF,OAAO,CAACC,OAAR,CAAgB,OAAOE,KAAP,KAAiB,UAAjC,C;;AAFiB7B,a,CAKZ8B,I,GAAO,MAASJ,OAAO,CAACC,OAAR,CAAgB,EAAhB,C;;AALJ3B,a,CAMZ+B,M,GAAUC,SAAD,KAAmB;AACjCC,EAAAA,WAAW,EAAE,MAAM,CAAE;AADY,CAAnB,C;;AANGjC,a,CAUZK,K,GAAQ,OAAOF,GAAP,EAAoBC,OAAe,GAAG,IAAtC,KAA+C;AAC5D,QAAMO,QAAQ,GAAG,MAAM,oBAAM;AAAER,IAAAA,GAAF;AAAOC,IAAAA;AAAP,GAAN,CAAvB;;AACA,MAAIO,QAAQ,CAACO,MAAT,KAAoB,GAAxB,EAA6B;AAC3B,UAAM,IAAIC,sBAAJ,CACJ,oCACEhB,GADF,GAEE,YAFF,GAGEQ,QAAQ,CAACO,MAJP,EAKJ,4BALI,CAAN;AAOD;AACF,C","sourcesContent":["//@flow\nimport Transport from \"@ledgerhq/hw-transport\";\nimport { TransportError } from \"@ledgerhq/errors\";\nimport axios from \"axios\";\nimport { log } from \"@ledgerhq/logs\";\n\n/**\n * HTTP transport implementation\n */\nexport default class HttpTransport extends Transport<string> {\n  static isSupported = (): Promise<boolean> =>\n    Promise.resolve(typeof fetch === \"function\");\n\n  // this transport is not discoverable\n  static list = (): * => Promise.resolve([]);\n  static listen = (_observer: *) => ({\n    unsubscribe: () => {},\n  });\n\n  static check = async (url: string, timeout: number = 5000) => {\n    const response = await axios({ url, timeout });\n    if (response.status !== 200) {\n      throw new TransportError(\n        \"failed to access HttpTransport(\" +\n          url +\n          \"): status \" +\n          response.status,\n        \"HttpTransportNotAccessible\"\n      );\n    }\n  };\n\n  static async open(url: string, timeout?: number) {\n    await HttpTransport.check(url, timeout);\n    return new HttpTransport(url);\n  }\n\n  url: string;\n\n  constructor(url: string) {\n    super();\n    this.url = url;\n  }\n\n  async exchange(apdu: Buffer): Promise<Buffer> {\n    const apduHex = apdu.toString(\"hex\");\n    log(\"apdu\", \"=> \" + apduHex);\n    const response = await axios({\n      method: \"POST\",\n      url: this.url,\n      headers: {\n        Accept: \"application/json\",\n        \"Content-Type\": \"application/json\",\n      },\n      data: JSON.stringify({ apduHex }),\n    });\n    if (response.status !== 200) {\n      throw new TransportError(\n        \"failed to communicate to server. code=\" + response.status,\n        \"HttpTransportStatus\" + response.status\n      );\n    }\n    const body = await response.data;\n    if (body.error) throw body.error;\n    log(\"apdu\", \"<= \" + body.data);\n    return Buffer.from(body.data, \"hex\");\n  }\n\n  setScrambleKey() {}\n\n  close(): Promise<void> {\n    return Promise.resolve();\n  }\n}\n"],"file":"HttpTransport.js"}